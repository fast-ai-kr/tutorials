<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>사용자 정의 모델 만들기 (Siamese) | tutorials from fast.ai KR</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="사용자 정의 모델 만들기 (Siamese)" />
<meta name="author" content="Chansung Park" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="fastai에서는 데이터를 정의하는 방법으로 DataBlock API를 제안합니다. 각 인자가 의미하는 내용과, 실제 Siamese 공식 튜토리얼에 이 내용이 어떻게 적용되는지를 살펴봅니다." />
<meta property="og:description" content="fastai에서는 데이터를 정의하는 방법으로 DataBlock API를 제안합니다. 각 인자가 의미하는 내용과, 실제 Siamese 공식 튜토리얼에 이 내용이 어떻게 적용되는지를 살펴봅니다." />
<link rel="canonical" href="https://fast-ai-kr.github.io/tutorials/model-siamese/" />
<meta property="og:url" content="https://fast-ai-kr.github.io/tutorials/model-siamese/" />
<meta property="og:site_name" content="tutorials from fast.ai KR" />
<meta property="og:image" content="https://fast-ai-kr.github.io/tutorials/images/datablock/siamese-model.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-11-22T00:00:00-06:00" />
<script type="application/ld+json">
{"image":"https://fast-ai-kr.github.io/tutorials/images/datablock/siamese-model.png","author":{"@type":"Person","name":"Chansung Park"},"description":"fastai에서는 데이터를 정의하는 방법으로 DataBlock API를 제안합니다. 각 인자가 의미하는 내용과, 실제 Siamese 공식 튜토리얼에 이 내용이 어떻게 적용되는지를 살펴봅니다.","@type":"BlogPosting","url":"https://fast-ai-kr.github.io/tutorials/model-siamese/","headline":"사용자 정의 모델 만들기 (Siamese)","dateModified":"2020-11-22T00:00:00-06:00","datePublished":"2020-11-22T00:00:00-06:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://fast-ai-kr.github.io/tutorials/model-siamese/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/tutorials/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://fast-ai-kr.github.io/tutorials/feed.xml" title="tutorials from fast.ai KR" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-177394312-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<link rel="shortcut icon" type="image/x-icon" href="/tutorials/images/favicon.ico"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>사용자 정의 모델 만들기 (Siamese) | tutorials from fast.ai KR</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="사용자 정의 모델 만들기 (Siamese)" />
<meta name="author" content="Chansung Park" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="fastai에서는 데이터를 정의하는 방법으로 DataBlock API를 제안합니다. 각 인자가 의미하는 내용과, 실제 Siamese 공식 튜토리얼에 이 내용이 어떻게 적용되는지를 살펴봅니다." />
<meta property="og:description" content="fastai에서는 데이터를 정의하는 방법으로 DataBlock API를 제안합니다. 각 인자가 의미하는 내용과, 실제 Siamese 공식 튜토리얼에 이 내용이 어떻게 적용되는지를 살펴봅니다." />
<link rel="canonical" href="https://fast-ai-kr.github.io/tutorials/model-siamese/" />
<meta property="og:url" content="https://fast-ai-kr.github.io/tutorials/model-siamese/" />
<meta property="og:site_name" content="tutorials from fast.ai KR" />
<meta property="og:image" content="https://fast-ai-kr.github.io/tutorials/images/datablock/siamese-model.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-11-22T00:00:00-06:00" />
<script type="application/ld+json">
{"image":"https://fast-ai-kr.github.io/tutorials/images/datablock/siamese-model.png","author":{"@type":"Person","name":"Chansung Park"},"description":"fastai에서는 데이터를 정의하는 방법으로 DataBlock API를 제안합니다. 각 인자가 의미하는 내용과, 실제 Siamese 공식 튜토리얼에 이 내용이 어떻게 적용되는지를 살펴봅니다.","@type":"BlogPosting","url":"https://fast-ai-kr.github.io/tutorials/model-siamese/","headline":"사용자 정의 모델 만들기 (Siamese)","dateModified":"2020-11-22T00:00:00-06:00","datePublished":"2020-11-22T00:00:00-06:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://fast-ai-kr.github.io/tutorials/model-siamese/"},"@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
<link rel="stylesheet" href="//use.fontawesome.com/releases/v5.0.7/css/all.css"><link type="application/atom+xml" rel="alternate" href="https://fast-ai-kr.github.io/tutorials/feed.xml" title="tutorials from fast.ai KR" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-177394312-1','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<script src="https://hypothes.is/embed.js" async></script>

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/tutorials/">tutorials from fast.ai KR</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/tutorials/about/">About Me</a><a class="page-link" href="/tutorials/search/">Search</a><a class="page-link" href="/tutorials/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">사용자 정의 모델 만들기 (Siamese)</h1><p class="page-description">fastai에서는 데이터를 정의하는 방법으로 DataBlock API를 제안합니다. 각 인자가 의미하는 내용과, 실제 Siamese 공식 튜토리얼에 이 내용이 어떻게 적용되는지를 살펴봅니다.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-11-22T00:00:00-06:00" itemprop="datePublished">
        Nov 22, 2020
      </time>• 
          <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span class="p-author h-card" itemprop="name">Chansung Park</span></span>
       • <span class="read-time" title="Estimated read time">
    
    
      5 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/tutorials/categories/#model">model</a>
        &nbsp;
      
        <a class="category-tags-link" href="/tutorials/categories/#siamese">siamese</a>
        &nbsp;
      
        <a class="category-tags-link" href="/tutorials/categories/#fastai">fastai</a>
        
      
      </p>
    

    
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#SiameseModel-개요">SiameseModel 개요 </a></li>
<li class="toc-entry toc-h2"><a href="#Module">class Module[source]</a></li>
<li class="toc-entry toc-h2"><a href="#encoder(body)와-head">encoder(body)와 head </a>
<ul>
<li class="toc-entry toc-h3"><a href="#모델의-메타데이터">모델의 메타데이터 </a></li>
<li class="toc-entry toc-h3"><a href="#encoder-만들기">encoder 만들기 </a>
<ul>
<li class="toc-entry toc-h4"><a href="#create_body">create_body[source]</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#head-만들기">head 만들기 </a>
<ul>
<li class="toc-entry toc-h4"><a href="#create_head">create_head[source]</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#SiameseModel과-Learner의-생성">SiameseModel과 Learner의 생성 </a></li>
</ul><!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-11-22-Siamese Model.ipynb
-->

<div class="container" id="notebook-container">
        
    
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>이번 포스팅에서는 이전 포스팅 "<a href="https://fast-ai-kr.github.io/tutorials/datablock-siamese/">데이터 블록 만드는 법 (Siamese)</a>"에서 만든 <strong>DataBlock</strong>을 수용할 수 있는 모델을 만드는 방법을 다룹니다. 기본적으로는 PyTorch의 <strong>nn.Module</strong>을 상속받아서 모델을 만들면 그만이지만, 이 때 <strong>fastai</strong>에서 제공하는 몇 가지 편리한 함수를 살펴볼 것입니다.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="SiameseModel-개요">
<a class="anchor" href="#SiameseModel-%EA%B0%9C%EC%9A%94" aria-hidden="true"><span class="octicon octicon-link"></span></a>SiameseModel 개요<a class="anchor-link" href="#SiameseModel-%EA%B0%9C%EC%9A%94"> </a>
</h2>
<p>우선 Siamese 모델이 하는 일을 다시 한번 생각해 봅시다. 이 모델은 두 이미지를 입력받아서, 두 이미지가 같은 부류에 속하는지를 판단하여 같다면 <strong>True</strong>, 다르다면 <strong>False</strong> 라는 결과를 예측합니다.</p>
<p>아래의 코드는 <strong>SiameseModel</strong> 이라는 간단한 모듈을 보여줍니다. 이 모듈은 PyTorch의 <strong>nn.Module</strong> 대신, fastai의 <strong>Module</strong>을 상속받아서 구현되었습니다. <strong>nn.Module</strong>과 <strong>Module</strong>의 차이는 단순히 <strong><strong>init</strong></strong> 메서드 내에서, <strong>super.<strong>init</strong></strong> 부모 메서드를 호출할 필요가 있는지 없는지 입니다. 따라서, <strong>super.<strong>init</strong></strong> 을 호출한다면, <strong>nn.Module</strong>을 사용해도 무방한 것이죠.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">SiameseModel</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="n">head</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">,</span><span class="n">head</span>
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">x1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">x2</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>아래의 <strong>Module</strong> 닥스트링을 통해서, 해당 설명을 확인해 보기 바랍니다.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Module" class="doc_header">
<a class="anchor" href="#Module" aria-hidden="true"><span class="octicon octicon-link"></span></a><code>class</code> <code>Module</code><a href="https://github.com/fastai/fastai/tree/master/fastai/torch_core.py#L538" class="source_link" style="float:right">[source]</a>
</h2>
<blockquote>
<p><code>Module</code>() :: <code>Module</code></p>
</blockquote>
<p>Same as <code>nn.Module</code>, but no need for subclasses to call <code>super().__init__</code></p>

</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>SiameseModel</strong>이 구현된 방식을 한번 살펴보겠습니다. 우선 생성자인 <strong><strong>init</strong></strong> 메서드는 두 개의 인자 (<strong>encoder</strong>, <strong>head</strong>)를 수용합니다. 이 둘은 각각 일반적인 CNN 모델에서 흔히 알고 있는 특징 추출을 담당하는 <strong>Convolutional Layers</strong> 와 분류를 담당하는 <strong>Fully Connected Layers</strong> 를 의미합니다.</p>
<p>이 두개를 입력받는 이유는 <strong>전이학습</strong>을 위해서 입니다. 일반적으로 <strong>전이학습</strong>은 사전에 훈련된 모델의 <strong>Convolutional Layers</strong>의 가중치를 그대로 활용합니다. 즉, 수 많은 이미지로부터 다양한 특징을 추출하는 능력을 이어받는 것이죠. 따라서, 이 부분이 <strong>encoder</strong>에 해당합니다.</p>
<p>하지만, 사전 훈련된 모델이 풀고자 했던 문제와 내가 현재 풀고자 하는 문제는 다릅니다. 분류 할 범주의 개수도 다르며, 종류도 다릅니다. 따라서 마지막 <strong>head</strong> 부분을 나의 문제에 맞게 구조를 잡은 다음, 이를 <strong>encoder</strong>와 결합해 주는 것입니다.</p>
<p><strong>fastai</strong> 에서는 사전 훈련된 모델로부터 <strong>encoder</strong> 부분을 추출하는 편리한 메서드로, <strong>create_body</strong>를 제공합니다. 또한 일반적인 구조의 <strong>head</strong>를 만들어주는 <strong>create_head</strong> 메서드도 함께 제공합니다. 즉, <strong>create_body</strong>로 <strong>encoder</strong>를 추출한 다음, <strong>create_head</strong>로 생성된 부분을 <strong>encoder</strong>와 결합해 주면 되는 것입니다.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/tutorials/images/copied_from_nb/datablock/siamese-model-transfer-learning.png" alt=""></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>이 내용을 숙지한 상태로, 다시한번 <strong>SiameseModel</strong>의 구현 코드를 살펴봅시다.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">SiameseModel</span><span class="p">(</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoder</span><span class="p">,</span> <span class="n">head</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">,</span><span class="n">head</span>
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">):</span>
        <span class="n">filters</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">x1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">x2</span><span class="p">)],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">filters</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong><strong>init</strong></strong> 생성자는 단순히 <strong>encoder</strong>와 <strong>head</strong>를 수용하여, 내부 변수에 저장합니다. 그리고, <strong>forward</strong>는 <strong>x1</strong>과 <strong>x2</strong> 두 개의 인자를 수용하는데, 각각은 비교되어야 할 서로다른 이미지 두 개를 의미합니다. 각 이미지를 <strong>encoder</strong>에 전달한 다음, <strong>torch.cat</strong> 함수를 통해 그 결과를 이어 붙여줍니다. 즉, 원래 <strong>encoder</strong>가 출력하는 결과의 두 배의 양이되는 것이죠. 다만, 양은 두개지만 서로다른 <strong>encoder</strong>를 사용하는 것이 아니므로, 가중치는 공유됩니다.</p>
<p>그 다음, 이어 붙여진 결과를 단순히 <strong>head</strong>로 삽입해 주는것으로 <strong>SiameseModel</strong>의 역할은 끝이납니다.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="encoder(body)와-head">
<a class="anchor" href="#encoder(body)%EC%99%80-head" aria-hidden="true"><span class="octicon octicon-link"></span></a>encoder(body)와 head<a class="anchor-link" href="#encoder(body)%EC%99%80-head"> </a>
</h2>
<p>그러면 이제 우리가 해야할 일은 <strong>encoder</strong>와 <strong>head</strong>를 만들어 주는 것입니다. 직접 <strong>encoder</strong>를 만들어서 밑바닥부터 학습을 진행해도 좋지만, 이미 이미지넷을 통해서 사전에 학습된 훌륭한 모델들이 존재합니다. 가령 <strong>ResNet</strong>, <strong>xResNet</strong>, <strong>EfficientNet</strong> 등과 같은것이 있을 수 있겠죠.</p>
<p><strong>fastai</strong>에서는 기본적으로 <strong>ResNet</strong>, <strong>xResNet</strong>, <strong>VGG</strong>, <strong>AlexNet</strong>, <strong>DenseNet</strong>, <strong>SqueezeNet</strong> 을 기본적으로 제공합니다. 그 중 <strong>ResNet</strong>은 사실 PyTorch에서 제공하는 모델을 그대로 활용하죠. 다만 <strong>fastai</strong>에서 제공되는 모델은 추가적인 메타데이터가 함께 딸려옵니다. 이 메타데이터가 의미하는바를 먼저 알아보도록 하겠습니다.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="모델의-메타데이터">
<a class="anchor" href="#%EB%AA%A8%EB%8D%B8%EC%9D%98-%EB%A9%94%ED%83%80%EB%8D%B0%EC%9D%B4%ED%84%B0" aria-hidden="true"><span class="octicon octicon-link"></span></a>모델의 메타데이터<a class="anchor-link" href="#%EB%AA%A8%EB%8D%B8%EC%9D%98-%EB%A9%94%ED%83%80%EB%8D%B0%EC%9D%B4%ED%84%B0"> </a>
</h3>
<p>다음은 <strong>resnet34</strong>에 대한 메타데이터가 가진 정보를 보여줍니다. <strong>fastai</strong>에서 제공하는 <strong>model_meta</strong> 딕셔너리 정보를 통해서, 각 모델의 메타데이터 정보를 조회할 수 있습니다.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model_meta</span><span class="p">[</span><span class="n">resnet34</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{'cut': -2,
 'split': &lt;function fastai.vision.learner._resnet_split(m)&gt;,
 'stats': ([0.485, 0.456, 0.406], [0.229, 0.224, 0.225])}</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>보다시피 세 개의 키값(<strong>cut</strong>, <strong>split</strong>, <strong>stats</strong>) 에 대한 정보를 가지고 있습니다. 각 키값이 의미하는바는 다음과 같습니다.</p>
<ul>
<li>
<strong>cut</strong><ul>
<li>CNN 구조에서, Fully Connected Layers가 시작되는 지점의 인덱스를 의미합니다. 즉, 개념적으로 생각해 보자면 <strong>resnet34[-2]</strong> 와 같이 접근하면, Fully Connected Layers를 제외한 나머지 Convolutional Layers 들 만을 가지고 올 수 있게 되는 것이죠. 이는 사전학습된 모델에서 Fully Connected Layer를 제거하고, 나만의 문제에 적합한 Fully Connected Layers를 추가하는 전이학습을 수행할 때 매우 도움이 되는 정보입니다.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>
<strong>split</strong><ul>
<li>split은 전이학습시 <strong>freeze</strong>되어야 하는 부분을 포함해서, 차별적 학습률이 적용된 파라미터 그룹을 구분짓습니다. <strong>fastai</strong>가 제공하는 모델 학습 시스템은 계층별로 차별적인 학습률을 둘 수 있도록 설계되어 있고, <strong>split</strong> 정보에는 차별적인 학습률이 적용된 계층 그룹에 대한 정보가 담겨 있습니다.</li>
</ul>
</li>
</ul>
<hr>
<ul>
<li>
<strong>stats</strong><ul>
<li>사전 학습된 모델이 학습한 데이터의 통계적 정보(<strong>평균</strong>, <strong>표준편차</strong>)를 저장합니다. 특정 모델이 학습한 데이터를 구성하는 값의 분포를 알고, 새로운 데이터를 그 분포에 맞도록 변형해 주면 전이학습의 효과를 좀 더 끌어올릴 수 있는 전략에 사용됩니다. 이 정보는 <strong>DataBlock</strong> 구성시 <strong>batch_tfms</strong>에 자동으로 삽입됩니다. </li>
</ul>
</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="encoder-만들기">
<a class="anchor" href="#encoder-%EB%A7%8C%EB%93%A4%EA%B8%B0" aria-hidden="true"><span class="octicon octicon-link"></span></a>encoder 만들기<a class="anchor-link" href="#encoder-%EB%A7%8C%EB%93%A4%EA%B8%B0"> </a>
</h3>
<p>모델의 메타데이터 정보를 가지고 있으므로, 이를 활용하여 <strong>encoder</strong> 부분을 잘라낼 수 있을 것입니다 (그렇지 않다면, 직접 모델의 구조를 파악한 후 자르는 지점을 결정해야만 합니다). 특히 <strong>cut</strong> 정보가 있을 때, <strong>fastai</strong>에서 제공하는 <strong>create_body</strong> 함수를 활용하면 쉽게 자를 수 있습니다.</p>
<p>먼저 <strong>create_body</strong> 함수의 원형을 살펴보죠.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="create_body" class="doc_header">
<a class="anchor" href="#create_body" aria-hidden="true"><span class="octicon octicon-link"></span></a><code>create_body</code><a href="https://github.com/fastai/fastai/tree/master/fastai/vision/learner.py#L63" class="source_link" style="float:right">[source]</a>
</h4>
<blockquote>
<p><code>create_body</code>(<strong><code>arch</code></strong>, <strong><code>n_in</code></strong>=<em><code>3</code></em>, <strong><code>pretrained</code></strong>=<em><code>True</code></em>, <strong><code>cut</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Cut off the body of a typically pretrained <code>arch</code> as determined by <code>cut</code></p>

</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>여기서의 <strong>arch</strong>는 모델이다. 즉 <strong>resnet18</strong>, <strong>resnet50</strong>과 같은 것이 됩니다. 유념해야 하는 인자는 <strong>cut</strong> 입니다. 바로 이 부분에 모델의 메타데이터의 <strong>cut</strong> 정보를 넣어주면 됩니다.</p>
<p>다음은 <strong>resnet34</strong>에 대하여 <strong>create_body</strong> 함수를 수행하여 얻은 결과로부터, 가장 마지막 인덱스에 해당하는 것을 가져옵니다. 이름에서 알 수 있듯이 34계층으로 구성되어 있기 때문에, 다소 많은 출력을 피하기 위한 목적과, 가장 마지막 계층이 Convolutional Layer로 끝난다는 사실을 확인하기 위함입니다.</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">encoder</span> <span class="o">=</span> <span class="n">create_body</span><span class="p">(</span><span class="n">resnet34</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="n">model_meta</span><span class="p">[</span><span class="n">resnet34</span><span class="p">][</span><span class="s1">'cut'</span><span class="p">])</span>
<span class="n">encoder</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Sequential(
  (0): BasicBlock(
    (conv1): Conv2d(256, 512, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
    (bn1): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (relu): ReLU(inplace=True)
    (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
    (bn2): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (downsample): Sequential(
      (0): Conv2d(256, 512, kernel_size=(1, 1), stride=(2, 2), bias=False)
      (1): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    )
  )
  (1): BasicBlock(
    (conv1): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
    (bn1): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (relu): ReLU(inplace=True)
    (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
    (bn2): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  )
  (2): BasicBlock(
    (conv1): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
    (bn1): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
    (relu): ReLU(inplace=True)
    (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
    (bn2): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  )
)</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="head-만들기">
<a class="anchor" href="#head-%EB%A7%8C%EB%93%A4%EA%B8%B0" aria-hidden="true"><span class="octicon octicon-link"></span></a>head 만들기<a class="anchor-link" href="#head-%EB%A7%8C%EB%93%A4%EA%B8%B0"> </a>
</h3>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">head</span> <span class="o">=</span> <span class="n">create_head</span><span class="p">(</span><span class="mi">512</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ps</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="create_head" class="doc_header">
<a class="anchor" href="#create_head" aria-hidden="true"><span class="octicon octicon-link"></span></a><code>create_head</code><a href="https://github.com/fastai/fastai/tree/master/fastai/vision/learner.py#L76" class="source_link" style="float:right">[source]</a>
</h4>
<blockquote>
<p><code>create_head</code>(<strong><code>nf</code></strong>, <strong><code>n_out</code></strong>, <strong><code>lin_ftrs</code></strong>=<em><code>None</code></em>, <strong><code>ps</code></strong>=<em><code>0.5</code></em>, <strong><code>concat_pool</code></strong>=<em><code>True</code></em>, <strong><code>bn_final</code></strong>=<em><code>False</code></em>, <strong><code>lin_first</code></strong>=<em><code>False</code></em>, <strong><code>y_range</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Model head that takes <code>nf</code> features, runs through <code>lin_ftrs</code>, and out <code>n_out</code> classes.</p>

</div>

</div>

</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">head</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>Sequential(
  (0): AdaptiveConcatPool2d(
    (ap): AdaptiveAvgPool2d(output_size=1)
    (mp): AdaptiveMaxPool2d(output_size=1)
  )
  (1): Flatten(full=False)
  (2): BatchNorm1d(2048, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  (3): Dropout(p=0.25, inplace=False)
  (4): Linear(in_features=2048, out_features=512, bias=False)
  (5): ReLU(inplace=True)
  (6): BatchNorm1d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  (7): Dropout(p=0.5, inplace=False)
  (8): Linear(in_features=512, out_features=2, bias=False)
)</pre>
</div>

</div>

</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered">
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="SiameseModel과-Learner의-생성">
<a class="anchor" href="#SiameseModel%EA%B3%BC-Learner%EC%9D%98-%EC%83%9D%EC%84%B1" aria-hidden="true"><span class="octicon octicon-link"></span></a>SiameseModel과 Learner의 생성<a class="anchor-link" href="#SiameseModel%EA%B3%BC-Learner%EC%9D%98-%EC%83%9D%EC%84%B1"> </a>
</h2>
</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">SiameseModel</span><span class="p">(</span><span class="n">encoder</span><span class="p">,</span> <span class="n">head</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">siamese_splitter</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">params</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">encoder</span><span class="p">),</span> <span class="n">params</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">head</span><span class="p">)]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">loss_func</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">targ</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">CrossEntropyLossFlat</span><span class="p">()(</span><span class="n">out</span><span class="p">,</span> <span class="n">targ</span><span class="o">.</span><span class="n">long</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="fast-ai-kr/tutorials"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/tutorials/model-siamese/" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/tutorials/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/tutorials/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/tutorials/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>An easy to use blogging platform with support for Jupyter Notebooks.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/deep-diver" target="_blank" title="deep-diver"><svg class="svg-icon grey"><use xlink:href="/tutorials/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/algo_diver" target="_blank" title="algo_diver"><svg class="svg-icon grey"><use xlink:href="/tutorials/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
